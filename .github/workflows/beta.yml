name: Beta Build

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  beta:
    name: Build & Upload to TestFlight
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Needed for changelog_from_git_commits

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install Fastlane
        run: gem install fastlane --no-document

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Run tests + upload beta
        env:
          APPLE_ID:                 ${{ secrets.APPLE_ID }}
          TEAM_ID:                  ${{ secrets.TEAM_ID }}
          ITC_TEAM_ID:              ${{ secrets.ITC_TEAM_ID }}
          MATCH_REPO_URL:           ${{ secrets.MATCH_REPO_URL }}
          MATCH_PASSWORD:           ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
          SLACK_WEBHOOK_URL:        ${{ secrets.SLACK_WEBHOOK_URL }}
          GIT_AUTHOR_NAME:          github-actions
          GIT_AUTHOR_EMAIL:         github-actions@github.com
        run: fastlane ios beta
